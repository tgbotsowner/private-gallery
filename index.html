<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />

<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />
<meta name="apple-mobile-web-app-title" content="Gallery" />

<title>Private Gallery</title>
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#000" />

<style>
body {
    margin: 0;
    padding: 0 env(safe-area-inset-right) 0 env(safe-area-inset-left);
    background: #000;
    color: #fff;
    font-family: Arial, sans-serif;
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

/* LOGIN */
#authScreen {
    position: fixed;
    inset: 0;
    background: #000;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    text-align: center;
    z-index: 9999;
    padding: 20px;
}

#authBox {
    width: 100%;
    max-width: 340px;
}

#accessCode {
    width: 100%;
    padding: 12px;
    margin-top: 10px;
    border-radius: 10px;
    border: 1px solid #333;
    background: #111;
    color: #fff;
    font-size: 18px;
    text-align: center;
}

#authBox button {
    width: 100%;
    margin-top: 12px;
    padding: 12px;
    border-radius: 10px;
    border: none;
    background: #1fa553;
    color: #fff;
    font-size: 18px;
}

#authError {
    margin-top: 8px;
    color: #ff3b3b;
    min-height: 18px;
    font-size: 15px;
}

/* MAIN APP */
#app {
    display: none;
    height: 100%;
    flex-direction: column;
}

h3 {
    text-align: center;
    margin: 8px 0;
}

#viewer {
    flex: 1;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
    background: #000;
}

#viewer img {
    width: 100vw;
    height: calc(100vh - 110px);
    object-fit: contain;
    display: block;
}

#controls {
    display: flex;
    justify-content: center;
    padding: 10px 10px calc(10px + env(safe-area-inset-bottom));
    gap: 10px;
    background: #000;
    flex-wrap: wrap;
}

#controls button, #controls label {
    background: #1b1b1b;
    color: #fff;
    border: none;
    padding: 10px 18px;
    border-radius: 10px;
    font-size: 15px;
    cursor: pointer;
}

/* FULLSCREEN */
.fullscreen h3,
.fullscreen #controls { display: none; }

.fullscreen #viewer {
    position: fixed;
    inset: 0;
    z-index: 99999;
    background: #000;
}

.fullscreen #viewer img {
    width: 100vw;
    height: 100vh;
    object-fit: contain;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="authScreen">
    <div id="authBox">
        <h2>Доступ по коду</h2>
        <input id="accessCode" type="text" placeholder="Введите код" />
        <button onclick="checkCode()">Войти</button>
        <div id="authError"></div>
    </div>
</div>

<!-- MAIN APP -->
<div id="app">
    <h3>Галерея</h3>
    <div id="viewer"><span>Нет фото</span></div>

    <input type="file" id="picker" accept="image/*" multiple hidden />

    <div id="controls">
        <label for="picker">Добавить</label>
        <button onclick="removePhoto()">Удалить</button>
        <button onclick="toggleFull()">На весь экран</button>
    </div>
</div>

<script>
/* ACCESS SYSTEM */
const CODE_STORAGE = "validCodesDB";
const ACCESS_KEY = "gallery_access_granted";

/* FIX — missing DOM bindings */
const picker = document.getElementById("picker");
const viewer = document.getElementById("viewer");

let validCodes = JSON.parse(localStorage.getItem(CODE_STORAGE)) || [
"AB12CD","Q7X9PL","H2B4KM","W9T3ZA","M8F6CD",
"R4Y7QN","T5L2WP","Z9D8HF","B3N6VE","X7Q1JR",
"K2M9YS","ZX98QW","PL92AB","V7C3KD","JQ55LM",
"TR99WO","NP24QS","HF88ZX","KJ72FE","MD45CL",
"SA71PQ","DL39WE","VM84TZ","CF28RX","YU63NB",
"PO57AJ","GE11KV","TH44MS","WK06YD","RX73PL",
"BN19QF","ZS82GH","KC40VM","LU55RT","AJ90XE",
"QM81DC","PT36BW","FA67HL","ND04JQ","XV29KT",
"HG52PA","LB88CD","MS14QW","DT95ER","FW30UX",
"YP77SK","OV21BZ","CR68TM","JL59HQ","VE03NP"
];

localStorage.setItem(CODE_STORAGE, JSON.stringify(validCodes));

if (localStorage.getItem(ACCESS_KEY) === "1") showApp();

function checkCode(){
    const input = accessCode.value.trim().toUpperCase();
    const err = document.getElementById("authError");
    const idx = validCodes.indexOf(input);

    if(idx === -1){
        err.textContent = "Неверный или использованный код";
        return;
    }

    validCodes.splice(idx, 1);
    localStorage.setItem(CODE_STORAGE, JSON.stringify(validCodes));
    localStorage.setItem(ACCESS_KEY, "1");

    showApp();
}

function showApp(){
    authScreen.style.display = "none";
    app.style.display = "flex";
    show();
}

/* === GALLERY === */

let photos = JSON.parse(localStorage.getItem("photos") || "[]");
let index = 0;
let full = false;

picker.addEventListener("change", async e => {
    for (const f of e.target.files){
        photos.push(await fileToBase64(f));
    }
    save();
    show();
});

function fileToBase64(file){
    return new Promise(res=>{
        const r = new FileReader();
        r.onload = ()=>res(r.result);
        r.readAsDataURL(file);
    });
}

function show(){
    if(!photos.length){
        viewer.innerHTML = "<span>Нет фото</span>";
        return;
    }
    viewer.innerHTML = `<img src="${photos[index]}" id="img">`;
    document.getElementById("img").onclick = next;
}

function next(){
    index = (index + 1) % photos.length;
    show();
}

function removePhoto(){
    if(!photos.length) return;
    photos.splice(index,1);
    if(index>0) index--;
    save();
    show();
}

function toggleFull(){
    full = !full;
    document.body.classList.toggle("fullscreen", full);
}

function save(){ 
    localStorage.setItem("photos", JSON.stringify(photos)); 
}

/* === TRIPLE TAP EXIT FULLSCREEN === */
let tapCount = 0;
let tapTimer = null;

document.addEventListener("touchend", () => {
    tapCount++;

    if (tapCount === 3 && full) {
        full = false;
        document.body.classList.remove("fullscreen");
    }

    clearTimeout(tapTimer);
    tapTimer = setTimeout(() => {
        tapCount = 0;
    }, 350);
});

show();
</script>

</body>
</html>
