<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
  <title>Private Gallery</title>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <meta name="apple-mobile-web-app-title" content="Gallery" />
  <meta name="theme-color" content="#000" />

  <style>
    :root {
      --device-width: 390;
      --device-height: 844;
    }

    body {
      margin: 0;
      background: #000;
      color: #fff;
      font-family: Arial, sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    h2, h3 {
      text-align: center;
      margin: 10px 0;
    }

    #authScreen {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
      background: #000;
      z-index: 1000;
    }

    #authBox { width: 100%; max-width: 340px; text-align: center; }

    #authBox input {
      width: 100%;
      padding: 12px;
      margin-top: 8px;
      border-radius: 10px;
      border: 1px solid #444;
      background: #111;
      color: #fff;
      font-size: 18px;
      text-align: center;
    }

    #authBox button {
      width: 100%;
      margin-top: 12px;
      padding: 12px;
      border-radius: 10px;
      border: none;
      background: #1fa553;
      color: #fff;
      font-size: 18px;
    }

    #authError {
      margin-top: 8px;
      color: #ff3b3b;
      min-height: 18px;
      font-size: 14px;
    }

    #deviceScreen {
      position: fixed;
      inset: 0;
      display: none;
      flex-direction: column;
      background: #000;
      color: #fff;
      z-index: 900;
      padding: 16px;
      box-sizing: border-box;
    }

    #deviceList {
      flex: 1;
      overflow-y: auto;
      margin-top: 10px;
    }

    .device-group-title {
      margin-top: 12px;
      margin-bottom: 4px;
      font-weight: bold;
      font-size: 15px;
      opacity: .8;
    }

    .device-item {
      padding: 10px 12px;
      margin-bottom: 6px;
      border-radius: 8px;
      background: #111;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      font-size: 15px;
    }

    .device-item input { margin-right: 10px; }

    #deviceButtons {
      padding-top: 10px;
      border-top: 1px solid #222;
      display: flex;
      justify-content: center;
      gap: 10px;
    }

    #deviceButtons button {
      flex: 1;
      padding: 10px;
      border-radius: 10px;
      border: none;
      font-size: 16px;
    }

    #deviceButtons .primary { background: #1fa553; color: #fff; }
    #deviceButtons .secondary { background: #222; color: #fff; }

    #app {
      display: none;
      flex-direction: column;
      height: 100vh;
    }

    #viewer {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: auto;
      background: #000;
    }

    #viewer img {
      width: calc(var(--device-width) * 1px);
      height: calc(var(--device-height) * 1px);
      display: block;
    }

    #viewer span { color: #aaa; font-size: 16px; }

    #controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      padding: 10px 10px 12px 10px;
      background: #000;
      border-top: 1px solid #222;
    }

    #controls label,
    #controls button {
      background: #1c1c1c;
      border: none;
      border-radius: 10px;
      color: #fff;
      padding: 10px 16px;
      font-size: 15px;
      cursor: pointer;
    }

    /* ================= FULLSCREEN MODE ================= */

    #viewer.fullscreen-active {
      position: fixed !important;
      inset: 0 !important;
      z-index: 9999 !important;
      background: #000 !important;
    }

    #viewer.fullscreen-active img {
      width: 100vw !important;
      height: 100vh !important;
      object-fit: contain !important;
    }

    #viewer.fullscreen-active + #controls,
    #app.fullscreen-hide h3 {
      display: none !important;
    }
  </style>
</head>
<body>

  <!-- AUTH -->
  <div id="authScreen">
    <div id="authBox">
      <h2>Доступ по коду</h2>
      <input id="accessCode" type="text" placeholder="Введите код" autocomplete="off" />
      <button onclick="checkCode()">Войти</button>
      <div id="authError"></div>
    </div>
  </div>

  <!-- DEVICE SELECT -->
  <div id="deviceScreen">
    <h2 style="text-align:center;margin:8px 0 0 0;">Выберите ваш iPhone</h2>
    <div id="deviceList"></div>
    <div id="deviceButtons">
      <button class="primary" onclick="confirmDevice()">Продолжить</button>
    </div>
  </div>

  <!-- GALLERY -->
  <div id="app">
    <h3>Галерея</h3>
    <div id="viewer"><span>Нет фото</span></div>
    <input type="file" id="picker" accept="image/*" hidden />
    <div id="controls">
      <label for="picker">Добавить</label>
      <button onclick="toggleFullScreen()">На весь экран</button>
      <button onclick="removePhoto()">Удалить</button>
      <button onclick="next()">Следующее</button>
    </div>
  </div>

<script>
/* ====================== ACCESS CODES ====================== */

const CODE_STORAGE = "validCodesDB";
const ACCESS_KEY  = "gallery_access_granted";
const DEVICE_KEY  = "gallery_device_model";

let validCodes = JSON.parse(localStorage.getItem(CODE_STORAGE)) || [
  "AB12CD","Q7X9PL","H2B4KM","W9T3ZA","M8F6CD",
  "R4Y7QN","T5L2WP","Z9D8HF","B3N6VE","X7Q1JR",
  "K2M9YS","ZX98QW","PL92AB","V7C3KD","JQ55LM",
  "TR99WO","NP24QS","HF88ZX","KJ72FE","MD45CL",
  "SA71PQ","DL39WE","VM84TZ","CF28RX","YU63NB",
  "PO57AJ","GE11KV","TH44MS","WK06YD","RX73PL",
  "BN19QF","ZS82GH","KC40VM","LU55RT","AJ90XE",
  "QM81DC","PT36BW","FA67HL","ND04JQ","XV29KT",
  "HG52PA","LB88CD","MS14QW","DT95ER","FW30UX",
  "YP77SK","OV21BZ","CR68TM","JL59HQ","VE03NP"
];

localStorage.setItem(CODE_STORAGE, JSON.stringify(validCodes));

/* ======================= DEVICES ======================= */

const DEVICES = [
  { group:"iPhone 11", items:[{id:"iphone11",name:"iPhone 11",cssW:414,cssH:896},{id:"iphone11pro",name:"iPhone 11 Pro",cssW:375,cssH:812},{id:"iphone11promax",name:"iPhone 11 Pro Max",cssW:414,cssH:896}] },
  { group:"iPhone 12", items:[{id:"iphone12",name:"iPhone 12",cssW:390,cssH:844},{id:"iphone12pro",name:"iPhone 12 Pro",cssW:390,cssH:844},{id:"iphone12promax",name:"iPhone 12 Pro Max",cssW:428,cssH:926}] },
  { group:"iPhone 13", items:[{id:"iphone13",name:"iPhone 13",cssW:390,cssH:844},{id:"iphone13pro",name:"iPhone 13 Pro",cssW:390,cssH:844},{id:"iphone13promax",name:"iPhone 13 Pro Max",cssW:428,cssH:926}] },
  { group:"iPhone 14", items:[{id:"iphone14",name:"iPhone 14",cssW:390,cssH:844},{id:"iphone14plus",name:"iPhone 14 Plus",cssW:428,cssH:926},{id:"iphone14pro",name:"iPhone 14 Pro",cssW:393,cssH:852},{id:"iphone14promax",name:"iPhone 14 Pro Max",cssW:430,cssH:932}] },
  { group:"iPhone 15", items:[{id:"iphone15",name:"iPhone 15",cssW:393,cssH:852},{id:"iphone15plus",name:"iPhone 15 Plus",cssW:430,cssH:932},{id:"iphone15pro",name:"iPhone 15 Pro",cssW:393,cssH:852},{id:"iphone15promax",name:"iPhone 15 Pro Max",cssW:430,cssH:932}] }
];

function renderDeviceList() {
  const list = document.getElementById("deviceList");
  list.innerHTML = "";
  DEVICES.forEach(group => {
    const title = document.createElement("div");
    title.className = "device-group-title";
    title.textContent = group.group;
    list.appendChild(title);
    group.items.forEach(dev => {
      const row = document.createElement("label");
      row.className = "device-item";
      row.innerHTML = `<span><input type="radio" name="device" value="${dev.id}">${dev.name}</span><span style="opacity:.5;font-size:12px;">${dev.cssW}×${dev.cssH}</span>`;
      list.appendChild(row);
    });
  });
}

function applyDevice(id) {
  for (const g of DEVICES) {
    for (const d of g.items) {
      if (d.id === id) {
        document.documentElement.style.setProperty("--device-width", d.cssW);
        document.documentElement.style.setProperty("--device-height", d.cssH);
        return;
      }
    }
  }
}

/* =================== AUTH LOGIC =================== */

if (localStorage.getItem(ACCESS_KEY) === "1") {
  document.getElementById("authScreen").style.display = "none";
  const savedDevice = localStorage.getItem(DEVICE_KEY);
  if (savedDevice) { applyDevice(savedDevice); startApp(); }
  else showDeviceScreen();
}

function checkCode() {
  const val = document.getElementById("accessCode").value.trim().toUpperCase();
  const err = document.getElementById("authError");

  if (!val) return err.textContent = "Введите код";

  const idx = validCodes.indexOf(val);
  if (idx === -1) return err.textContent = "Неверный или использованный код";

  validCodes.splice(idx, 1);
  localStorage.setItem(CODE_STORAGE, JSON.stringify(validCodes));
  localStorage.setItem(ACCESS_KEY, "1");

  document.getElementById("authScreen").style.display = "none";
  showDeviceScreen();
}

function showDeviceScreen() {
  renderDeviceList();
  document.getElementById("deviceScreen").style.display = "flex";
}

function confirmDevice() {
  const checked = document.querySelector('input[name="device"]:checked');
  if (!checked) return alert("Выберите модель iPhone");
  localStorage.setItem(DEVICE_KEY, checked.value);
  applyDevice(checked.value);
  document.getElementById("deviceScreen").style.display = "none";
  startApp();
}

function startApp() {
  document.getElementById("app").style.display = "flex";
  show();
}

/* ====================== FULLSCREEN BLOCK ====================== */

function toggleFullScreen() {
  const viewer = document.getElementById("viewer");
  viewer.classList.toggle("fullscreen-active");
}

// выход по тройному тапу
let tapCount = 0;
let tapTimer;

document.addEventListener("touchend", () => {
  tapCount++;
  if (tapCount === 3) {
    document.getElementById("viewer").classList.remove("fullscreen-active");
  }
  clearTimeout(tapTimer);
  tapTimer = setTimeout(() => tapCount = 0, 300);
});

/* ====================== GALLERY ====================== */

let db;
let photos = [];
let indexPhoto = 0;

const DB_NAME = "galleryDB_v2";
const DB_STORE = "photos";

const openReq = indexedDB.open(DB_NAME, 1);

openReq.onupgradeneeded = e => {
  db = e.target.result;
  if (!db.objectStoreNames.contains(DB_STORE)) {
    db.createObjectStore(DB_STORE, { autoIncrement: true });
  }
};

openReq.onsuccess = e => {
  db = e.target.result;
  loadPhotos();
};

function loadPhotos() {
  if (!db) return;
  const tx = db.transaction(DB_STORE, "readonly");
  const store = tx.objectStore(DB_STORE);
  const req = store.getAll();
  req.onsuccess = () => {
    photos = req.result || [];
    if (indexPhoto >= photos.length) indexPhoto = 0;
    if (document.getElementById("app").style.display === "flex") show();
  };
}

picker.addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file || !db) return;

  if (photos.length >= 2) deleteFirstThenAdd(file);
  else addToDB(file);
});

function deleteFirstThenAdd(file) {
  const tx = db.transaction(DB_STORE, "readwrite");
  const store = tx.objectStore(DB_STORE);
  const curReq = store.openCursor();
  curReq.onsuccess = ev => {
    const cursor = ev.target.result;
    if (cursor) {
      cursor.delete();
      addToDB(file);
    }
  };
}

function addToDB(file) {
  const tx = db.transaction(DB_STORE, "readwrite");
  tx.objectStore(DB_STORE).add(file);
  tx.oncomplete = () => { picker.value = ""; loadPhotos(); };
}

function show() {
  const v = document.getElementById("viewer");

  if (!photos.length) return v.innerHTML = "<span>Нет фото</span>";

  const blob = photos[indexPhoto];
  const url  = URL.createObjectURL(blob);
  v.innerHTML = `<img src="${url}" id="currentPhoto">`;

  document.getElementById("currentPhoto").onclick = next;
}

function next() {
  if (!photos.length) return;
  indexPhoto = (indexPhoto + 1) % photos.length;
  show();
}

function removePhoto() {
  if (!photos.length || !db) return;

  const tx = db.transaction(DB_STORE, "readwrite");
  const store = tx.objectStore(DB_STORE);
  const curReq = store.openCursor();
  let i = 0;

  curReq.onsuccess = e => {
    const cursor = e.target.result;
    if (cursor) {
      if (i === indexPhoto) cursor.delete();
      i++;
      cursor.continue();
    }
  };

  tx.oncomplete = () => {
    if (indexPhoto > 0) indexPhoto--;
    loadPhotos();
  };
}
</script>

</body>
</html>
