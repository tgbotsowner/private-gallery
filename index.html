<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
  <title>Private Gallery</title>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <meta name="apple-mobile-web-app-title" content="Glovo" />
  <meta name="theme-color" content="#000" />

  <!-- Progressive Web App manifest -->
  <link rel="manifest" href="manifest.json">

<!-- iOS Home Screen Icons -->
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">

  
  <style>
    :root {
      /* логический размер экрана по умолчанию (например, iPhone 14) */
      --device-width: 390;
      --device-height: 844;
    }

    body {
      margin: 0;
      background: #000;
      color: #fff;
      font-family: Arial, sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    h2, h3 {
      text-align: center;
      margin: 10px 0;
    }

    /* ---------- ЭКРАН ВВОДА КОДА ---------- */

    #authScreen {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
      background: #000;
      z-index: 1000;
    }

    #authBox {
      width: 100%;
      max-width: 340px;
      text-align: center;
    }

    #authBox input {
      width: 100%;
      padding: 12px;
      margin-top: 8px;
      border-radius: 10px;
      border: 1px solid #444;
      background: #111;
      color: #fff;
      font-size: 18px;
      text-align: center;
    }

    #authBox button {
      width: 100%;
      margin-top: 12px;
      padding: 12px;
      border-radius: 10px;
      border: none;
      background: #1fa553;
      color: #fff;
      font-size: 18px;
      cursor: pointer;
    }

    #authError {
      margin-top: 8px;
      color: #ff3b3b;
      min-height: 18px;
      font-size: 14px;
    }

    /* ---------- ЭКРАН ВЫБОРА УСТРОЙСТВА ---------- */

    #deviceScreen {
      position: fixed;
      inset: 0;
      display: none;
      flex-direction: column;
      background: #000;
      color: #fff;
      z-index: 900;
      padding: 16px;
      box-sizing: border-box;
    }

    #deviceList {
      flex: 1;
      overflow-y: auto;
      margin-top: 10px;
    }

    .device-group-title {
      margin-top: 12px;
      margin-bottom: 4px;
      font-weight: bold;
      font-size: 15px;
      opacity: .8;
    }

    .device-item {
      padding: 10px 12px;
      margin-bottom: 6px;
      border-radius: 8px;
      background: #111;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      font-size: 15px;
    }

    .device-item input {
      margin-right: 10px;
    }

    #deviceButtons {
      padding-top: 10px;
      border-top: 1px solid #222;
      display: flex;
      justify-content: center;
      gap: 10px;
    }

    #deviceButtons button {
      flex: 1;
      padding: 10px;
      border-radius: 10px;
      border: none;
      font-size: 16px;
    }

    #deviceButtons .primary {
      background: #1fa553;
      color: #fff;
    }

    #deviceButtons .secondary {
      background: #222;
      color: #fff;
    }

    /* ---------- ОСНОВНОЕ ПРИЛОЖЕНИЕ ---------- */

    #app {
      display: none;
      flex-direction: column;
      height: 100vh;
    }

    #viewer {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: auto; /* scroll для длинных скринов */
      background: #000;
    }

    #viewer img {
      width: calc(var(--device-width) * 1px);
      height: calc(var(--device-height) * 1px);
      display: block;
    }

    #viewer span {
      color: #aaa;
      font-size: 16px;
    }

    #controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      padding: 10px 10px 12px 10px;
      background: #000;
      border-top: 1px solid #222;
    }

    #controls button {
      background: #1c1c1c;
      border: none;
      border-radius: 10px;
      color: #fff;
      padding: 10px 16px;
      font-size: 15px;
      cursor: pointer;
    }

    /* ---------- FULLSCREEN MODE (через класс на body) ---------- */

    body.fullscreen-mode h3,
    body.fullscreen-mode #controls {
      display: none !important;
    }

    body.fullscreen-mode #viewer {
      position: fixed !important;
      inset: 0 !important;
      z-index: 9999 !important;
      background: #000 !important;
      overflow: hidden !important;
    }

    body.fullscreen-mode #viewer img {
      width: 100vw !important;
      height: 100vh !important;
      object-fit: contain !important;
    }
  </style>
</head>
<body>

  <!-- ЭКРАН ДОСТУПА ПО КОДУ -->
  <div id="authScreen">
    <div id="authBox">
      <h2>Доступ по коду</h2>
      <input id="accessCode" type="text" placeholder="Введите код" autocomplete="off" />
      <button onclick="checkCode()">Войти</button>
      <div id="authError"></div>
    </div>
  </div>

  <!-- ЭКРАН ВЫБОРА УСТРОЙСТВА -->
  <div id="deviceScreen">
    <h2 style="text-align:center;margin:8px 0 0 0;">Выберите ваш iPhone</h2>
    <div id="deviceList"></div>
    <div id="deviceButtons">
      <button class="primary" onclick="confirmDevice()">Продолжить</button>
    </div>
  </div>

  <!-- ГАЛЕРЕЯ -->
  <div id="app">
    <h3>Галерея</h3>
    <div id="viewer"><span>Нет фото</span></div>

    <!-- input создаём динамически через JS -->

    <div id="controls">
      <button onclick="pick()">Добавить</button>
      <button onclick="toggleFullScreen()">На весь экран</button>
      <button onclick="removePhoto()">Удалить</button>
      <button onclick="next()">Следующее</button>
    </div>
  </div>

<script>
/* ===================== КОНСТАНТЫ ДОСТУПА ===================== */

const CODE_STORAGE  = "validCodesDB";
const USED_CODES_STORAGE = "usedCodesDB";
const ACCESS_KEY   = "gallery_access_granted";
const DEVICE_KEY   = "gallery_device_model";
const PHOTOS_KEY   = "gallery_photos_v1";

/* ===== КОДЫ ДОСТУПА (одноразовые) ===== */
const INITIAL_CODES = [
  "AB12CD","Q7X9PL","H2B4KM","W9T3ZA","M8F6CD",
  "R4Y7QN","T5L2WP","Z9D8HF","B3N6VE","X7Q1JR",
  "K2M9YS","ZX98QW","PL92AB","V7C3KD","JQ55LM",
  "TR99WO","NP24QS","HF88ZX","KJ72FE","MD45CL",
  "SA71PQ","DL39WE","VM84TZ","CF28RX","YU63NB",
  "PO57AJ","GE11KV","TH44MS","WK06YD","RX73PL",
  "BN19QF","ZS82GH","KC40VM","LU55RT","AJ90XE",
  "QM81DC","PT36BW","FA67HL","ND04JQ","XV29KT",
  "HG52PA","LB88CD","MS14QW","DT95ER","FW30UX",
  "YP77SK","OV21BZ","CR68TM","JL59HQ","VE03NP"
];

let validCodes;
let usedCodes;

try {
  const stored = localStorage.getItem(CODE_STORAGE);
  validCodes = stored ? JSON.parse(stored) : [...INITIAL_CODES];
} catch(e) {
  validCodes = [...INITIAL_CODES];
}
localStorage.setItem(CODE_STORAGE, JSON.stringify(validCodes));

try {
  usedCodes = JSON.parse(localStorage.getItem(USED_CODES_STORAGE) || "[]");
} catch(e) {
  usedCodes = [];
}

/* ======================== УСТРОЙСТВА ======================== */

const DEVICES = [
  { group:"iPhone 11", items:[
    {id:"iphone11",       name:"iPhone 11",        cssW:414, cssH:896},
    {id:"iphone11pro",    name:"iPhone 11 Pro",    cssW:375, cssH:812},
    {id:"iphone11promax", name:"iPhone 11 Pro Max",cssW:414, cssH:896},
  ]},
  { group:"iPhone 12", items:[
    {id:"iphone12",       name:"iPhone 12",        cssW:390, cssH:844},
    {id:"iphone12pro",    name:"iPhone 12 Pro",    cssW:390, cssH:844},
    {id:"iphone12promax", name:"iPhone 12 Pro Max",cssW:428, cssH:926},
  ]},
  { group:"iPhone 13", items:[
    {id:"iphone13",       name:"iPhone 13",        cssW:390, cssH:844},
    {id:"iphone13pro",    name:"iPhone 13 Pro",    cssW:390, cssH:844},
    {id:"iphone13promax", name:"iPhone 13 Pro Max",cssW:428, cssH:926},
  ]},
  { group:"iPhone 14", items:[
    {id:"iphone14",       name:"iPhone 14",        cssW:390, cssH:844},
    {id:"iphone14plus",   name:"iPhone 14 Plus",   cssW:428, cssH:926},
    {id:"iphone14pro",    name:"iPhone 14 Pro",    cssW:393, cssH:852},
    {id:"iphone14promax", name:"iPhone 14 Pro Max",cssW:430, cssH:932},
  ]},
  { group:"iPhone 15", items:[
    {id:"iphone15",       name:"iPhone 15",        cssW:393, cssH:852},
    {id:"iphone15plus",   name:"iPhone 15 Plus",   cssW:430, cssH:932},
    {id:"iphone15pro",    name:"iPhone 15 Pro",    cssW:393, cssH:852},
    {id:"iphone15promax", name:"iPhone 15 Pro Max",cssW:430, cssH:932},
  ]},
  { group:"iPhone 16", items:[
    {id:"iphone16",       name:"iPhone 16",        cssW:393, cssH:852},
    {id:"iphone16plus",   name:"iPhone 16 Plus",   cssW:430, cssH:932},
    {id:"iphone16pro",    name:"iPhone 16 Pro",    cssW:402, cssH:874},
    {id:"iphone16promax", name:"iPhone 16 Pro Max",cssW:442, cssH:960},
  ]},
];

function renderDeviceList() {
  const list = document.getElementById("deviceList");
  list.innerHTML = "";
  DEVICES.forEach(group => {
    const title = document.createElement("div");
    title.className = "device-group-title";
    title.textContent = group.group;
    list.appendChild(title);

    group.items.forEach(dev => {
      const row = document.createElement("label");
      row.className = "device-item";
      row.innerHTML = `
        <span>
          <input type="radio" name="device" value="${dev.id}">
          ${dev.name}
        </span>
        <span style="opacity:.5;font-size:12px;">${dev.cssW}×${dev.cssH}</span>
      `;
      list.appendChild(row);
    });
  });
}

function applyDevice(id) {
  for (const g of DEVICES) {
    for (const d of g.items) {
      if (d.id === id) {
        document.documentElement.style.setProperty("--device-width", d.cssW);
        document.documentElement.style.setProperty("--device-height", d.cssH);
        return;
      }
    }
  }
}

/* ======================== ФОТО (localStorage) ======================== */

let photos = [];        // массив dataURL
let indexPhoto = 0;

function loadPhotos() {
  try {
    const raw = localStorage.getItem(PHOTOS_KEY);
    photos = raw ? JSON.parse(raw) : [];
  } catch(e) {
    photos = [];
  }
}

function savePhotos() {
  try {
    localStorage.setItem(PHOTOS_KEY, JSON.stringify(photos));
  } catch(e) {
    // если localStorage забит — просто молча игнорим
  }
}

function readAndResize(file) {
  return new Promise(resolve => {
    const reader = new FileReader();
    reader.onload = e => {
      const img = new Image();
      img.onload = () => {
        const MAX_SIDE = 2048; // лёгкая оптимизация, без потери видимого качества
        let w = img.width;
        let h = img.height;
        const maxSide = Math.max(w, h);

        if (maxSide <= MAX_SIDE) {
          return resolve(e.target.result); // оригинал в base64
        }

        const scale = MAX_SIDE / maxSide;
        w = Math.round(w * scale);
        h = Math.round(h * scale);

        const canvas = document.createElement("canvas");
        canvas.width = w;
        canvas.height = h;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, w, h);
        const dataUrl = canvas.toDataURL("image/jpeg", 0.95);
        resolve(dataUrl);
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  });
}

function addPhotoFromFile(file) {
  readAndResize(file).then(dataUrl => {
    if (!dataUrl) return;
    if (photos.length >= 5) {
      // максимум 2 фото — удаляем самое старое
      photos.shift();
    }
    photos.push(dataUrl);
    indexPhoto = photos.length - 1;
    savePhotos();
    show();
  });
}

/* ======================== AUTH ЛОГИКА ======================== */

loadPhotos(); // сразу пытаемся загрузить локальные фото

if (localStorage.getItem(ACCESS_KEY) === "1") {
  document.getElementById("authScreen").style.display = "none";
  const savedDevice = localStorage.getItem(DEVICE_KEY);
  if (savedDevice) {
    applyDevice(savedDevice);
    startApp();
  } else {
    showDeviceScreen();
  }
}

function checkCode() {
  const val = document.getElementById("accessCode").value.trim().toUpperCase();
  const err = document.getElementById("authError");

  if (!val) {
    err.textContent = "Введите код";
    return;
  }

  const idx = validCodes.indexOf(val);
  if (idx === -1) {
    err.textContent = "Неверный или использованный код";
    return;
  }

  // одноразовый код — вырезаем и сохраняем
  validCodes.splice(idx, 1);
  localStorage.setItem(CODE_STORAGE, JSON.stringify(validCodes));

  usedCodes.push({ code: val, usedAt: Date.now() });
  localStorage.setItem(USED_CODES_STORAGE, JSON.stringify(usedCodes));

  localStorage.setItem(ACCESS_KEY, "1");

  document.getElementById("authScreen").style.display = "none";
  showDeviceScreen();
}

function showDeviceScreen() {
  renderDeviceList();
  document.getElementById("deviceScreen").style.display = "flex";
}

function confirmDevice() {
  const checked = document.querySelector('input[name="device"]:checked');
  if (!checked) {
    alert("Выберите модель iPhone");
    return;
  }
  localStorage.setItem(DEVICE_KEY, checked.value);
  applyDevice(checked.value);
  document.getElementById("deviceScreen").style.display = "none";
  startApp();
}

function startApp() {
  document.getElementById("app").style.display = "flex";
  show();
}

/* ======================== FULLSCREEN ======================== */

function toggleFullScreen() {
  document.body.classList.toggle("fullscreen-mode");
}

// выход из fullscreen по тройному тапу
let tapCount = 0;
let tapTimer;

document.addEventListener("touchend", () => {
  tapCount++;
  if (tapCount === 3) {
    document.body.classList.remove("fullscreen-mode");
  }
  clearTimeout(tapTimer);
  tapTimer = setTimeout(() => tapCount = 0, 300);
});

/* ======================== FILE INPUT (фикс для iOS) ======================== */

function createNewPicker() {
  const oldPicker = document.getElementById("picker");
  if (oldPicker) oldPicker.remove();

  const newPicker = document.createElement("input");
  newPicker.type = "file";
  newPicker.id = "picker";
  newPicker.accept = "image/*";
  newPicker.hidden = true;

  newPicker.addEventListener("change", e => {
    const file = e.target.files[0];
    if (!file) return;
    addPhotoFromFile(file);
  });

  document.body.appendChild(newPicker);
  window.picker = newPicker;
}

function pick() {
  createNewPicker();
  picker.click();
}

/* ======================== ГАЛЕРЕЯ ======================== */

function show() {
  const v = document.getElementById("viewer");

  if (!photos.length) {
    v.innerHTML = "<span>Нет фото</span>";
    return;
  }

  if (indexPhoto >= photos.length) indexPhoto = photos.length - 1;

  const url = photos[indexPhoto];
  v.innerHTML = `<img src="${url}" id="currentPhoto">`;

  document.getElementById("currentPhoto").onclick = next;
}

function next() {
  if (!photos.length) return;
  indexPhoto = (indexPhoto + 1) % photos.length;
  show();
}

function removePhoto() {
  if (!photos.length) return;
  photos.splice(indexPhoto, 1);
  if (indexPhoto > 0) indexPhoto--;
  savePhotos();
  show();
}
</script>

</body>
</html>
