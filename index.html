<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />
<meta name="apple-mobile-web-app-title" content="Gallery" />
<title>Private Gallery</title>
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#000" />

<style>
    body {
        margin: 0;
        padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        background: #000;
        color: #fff;
        font-family: Arial, sans-serif;
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    /* LOGIN */
    #authScreen {
        position: fixed;
        inset: 0;
        background: #000;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        padding: 20px;
        text-align: center;
    }

    #authBox {
        width: 90%;
        max-width: 330px;
    }

    #accessCode {
        width: 100%;
        padding: 14px;
        margin-top: 12px;
        border-radius: 12px;
        border: 1px solid #444;
        background: #111;
        color: white;
        font-size: 18px;
        text-align: center;
    }

    #authBox button {
        margin-top: 14px;
        width: 100%;
        padding: 14px;
        border-radius: 12px;
        border: none;
        font-size: 18px;
        background: #1fa553;
        color: #fff;
    }

    #authError {
        margin-top: 8px;
        color: #ff4747;
        min-height: 20px;
    }

    /* APP */
    #app {
        display: none;
        height: 100%;
        flex-direction: column;
        width: 100%;
    }

    #viewer {
        flex: 1;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
        background: #000;
    }

    #viewer img {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }

    #controls {
        display: flex;
        justify-content: center;
        gap: 12px;
        padding: 12px;
        background: #000;
    }

    #controls button, #controls label {
        padding: 10px 18px;
        border-radius: 10px;
        border: none;
        background: #1c1c1c;
        color: white;
        font-size: 15px;
    }

    input[type="file"] {
        display: none;
    }

    /* FULLSCREEN */
    .fullscreen #controls, .fullscreen h3 {
        display: none;
    }
    .fullscreen #viewer {
        position: fixed;
        inset: 0;
        background: #000;
        z-index: 3000;
    }
    .fullscreen #viewer img {
        width: 100vw;
        height: 100vh;
        object-fit: contain;
    }

    #loader {
        position: absolute;
        bottom: 80px;
        font-size: 14px;
        opacity: 0.7;
    }
</style>
</head>

<body>

<!-- LOGIN -->
<div id="authScreen">
    <div id="authBox">
        <h2>Доступ по коду</h2>
        <input id="accessCode" type="text" placeholder="Введите код" />
        <button onclick="checkCode()">Войти</button>
        <div id="authError"></div>
    </div>
</div>

<!-- APP -->
<div id="app">
    <h3 style="text-align:center; margin:10px 0;">Галерея</h3>
    <div id="viewer"><span>Нет фото</span></div>
    <div id="loader" style="display:none;">Загрузка...</div>

    <input type="file" id="picker" accept="image/*" multiple />

    <div id="controls">
        <label for="picker">Добавить</label>
        <button onclick="removePhoto()">Удалить</button>
        <button onclick="toggleFull()">На весь экран</button>
    </div>
</div>

<script>
/* === ACCESS SYSTEM (ONE–TIME) === */
const CODE_KEY = "validCodesDB";
const ACCESS_KEY = "gallery_access_granted";

let codes = JSON.parse(localStorage.getItem(CODE_KEY)) || [
"AB12CD","Q7X9PL","H2B4KM","W9T3ZA","M8F6CD",
"R4Y7QN","T5L2WP","Z9D8HF","B3N6VE","X7Q1JR",
"K2M9YS","ZX98QW","PL92AB","V7C3KD","JQ55LM",
"TR99WO","NP24QS","HF88ZX","KJ72FE","MD45CL",
"SA71PQ","DL39WE","VM84TZ","CF28RX","YU63NB",
"PO57AJ","GE11KV","TH44MS","WK06YD","RX73PL",
"BN19QF","ZS82GH","KC40VM","LU55RT","AJ90XE",
"QM81DC","PT36BW","FA67HL","ND04JQ","XV29KT",
"HG52PA","LB88CD","MS14QW","DT95ER","FW30UX",
"YP77SK","OV21BZ","CR68TM","JL59HQ","VE03NP"
];
localStorage.setItem(CODE_KEY, JSON.stringify(codes));

if(localStorage.getItem(ACCESS_KEY)==="1") showApp();

function checkCode(){
    const code = accessCode.value.trim().toUpperCase();
    const err = document.getElementById("authError");

    const idx = codes.indexOf(code);
    if(idx === -1){
        err.textContent = "Неверный или использованный код";
        return;
    }

    codes.splice(idx,1);
    localStorage.setItem(CODE_KEY, JSON.stringify(codes));
    localStorage.setItem(ACCESS_KEY,"1");
    showApp();
}

function showApp(){
    authScreen.style.display="none";
    app.style.display="flex";
    loadPhotos();
}

/* === INDEXED DB STORAGE === */
let db;
let photos = [];
let index = 0;
let full = false;

const request = indexedDB.open("PrivateGalleryDB",1);

request.onupgradeneeded = e => {
    db = e.target.result;
    db.createObjectStore("photos",{autoIncrement:true});
};

request.onsuccess = e => {
    db = e.target.result;
    loadPhotos();
};

function savePhoto(blob){
    const tx = db.transaction("photos","readwrite");
    tx.objectStore("photos").add(blob);
    tx.oncomplete = ()=> loadPhotos();
}

function deletePhoto(){
    const tx = db.transaction("photos","readwrite");
    const store = tx.objectStore("photos");
    store.delete(photos[index].id);
    tx.oncomplete = ()=> loadPhotos();
}

/* === GALLERY === */
picker.addEventListener("change", async e=>{
    loader.style.display="block";
    for(const file of e.target.files){
        savePhoto(await resizeBlob(file));
    }
    loader.style.display="none";
});

function loadPhotos(){
    const tx = db.transaction("photos","readonly");
    const store = tx.objectStore("photos");
    const req = store.getAll();
    req.onsuccess = ()=>{
        photos = req.result.map((blob,i)=>({id:i+1,blob}));
        if(index>=photos.length) index = photos.length-1;
        draw();
    };
}

function draw(){
    if(!photos.length){
        viewer.innerHTML="<span>Нет фото</span>";
        return;
    }

    const url = URL.createObjectURL(photos[index].blob);
    viewer.innerHTML = `<img src="${url}" />`;
}

function resizeBlob(file){
    return new Promise(res=>{
        const img = new Image();
        const reader = new FileReader();
        reader.onload = ()=> {
            img.src = reader.result;
            img.onload = ()=>{
                const canvas = document.createElement("canvas");
                const maxSize = 2000;
                let {width, height} = img;
                if(width > maxSize || height > maxSize){
                    const scale = Math.min(maxSize/width, maxSize/height);
                    width *= scale; height *= scale;
                }
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext("2d");
                ctx.drawImage(img,0,0,width,height);
                canvas.toBlob(res,"image/jpeg",0.9);
            }
        }
        reader.readAsDataURL(file);
    });
}

function next(){
    index = (index+1)%photos.length;
    draw();
}

function removePhoto(){
    if(!photos.length) return;
    deletePhoto();
}

function toggleFull(){
    full = !full;
    document.body.classList.toggle("fullscreen", full);
}

/* swipe */
viewer.addEventListener("click",next);
</script>

</body>
</html>
