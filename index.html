<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />

<!-- iOS PWA -->
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />
<meta name="apple-mobile-web-app-title" content="Gallery" />

<title>Gallery</title>
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#000" />

<style>
    body {
        margin: 0;
        padding: 0 env(safe-area-inset-right) 0 env(safe-area-inset-left);
        background: #000;
        color: #fff;
        font-family: Arial, sans-serif;
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    /* === AUTH SCREEN === */
    #authScreen {
        position: fixed;
        inset: 0;
        background: #000;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 99999;
        padding: 20px;
    }

    #authBox {
        width: 100%;
        max-width: 320px;
        text-align: center;
    }

    #authBox input {
        width: 100%;
        padding: 12px;
        margin-top: 8px;
        border-radius: 10px;
        border: 1px solid #444;
        background: #111;
        color: white;
        font-size: 18px;
        text-align: center;
    }

    #authBox button {
        margin-top: 12px;
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 10px;
        background: #13a353;
        font-size: 18px;
        color: white;
    }

    #authError {
        margin-top: 8px;
        min-height: 18px;
        color: #ff4d4d;
    }

    /* === APP === */
    #app {
        display: none;
        height: 100%;
        flex-direction: column;
    }

    h3 {
        text-align: center;
        padding-top: env(safe-area-inset-top, 8px);
        margin: 8px 0;
    }

    #viewer {
        flex: 1;
        width: 100%;
        overflow: hidden;
        display: flex;
        justify-content: center;
        align-items: center;
        background: #000;
        position: relative;
    }

    #viewer img {
        max-width: 100%;
        max-height: calc(100vh - 120px);
        width: auto;
        height: auto;
        object-fit: contain;
    }

    #controls {
        background: #000;
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        padding: 10px 0 calc(10px + env(safe-area-inset-bottom));
        gap: 10px;
    }

    #controls button {
        background: #1c1c1c;
        border: none;
        padding: 10px 16px;
        border-radius: 10px;
        color: #fff;
        font-size: 15px;
    }

    /* === FULLSCREEN IMAGE MODE === */
    .fullscreen h3,
    .fullscreen #controls {
        display: none;
    }

    .fullscreen #viewer {
        position: fixed;
        inset: 0;
        z-index: 9999;
        background: black;
        overflow-y: scroll;
        -webkit-overflow-scrolling: touch;
    }

    .fullscreen #viewer img {
        position: absolute;
        top: 0;
        left: 0;
        width: 100vw;
        height: auto;
        min-height: 100vh;
        object-fit: cover;
        object-position: top center;
    }
</style>
</head>

<body>

<!-- AUTH STEP -->
<div id="authScreen">
    <div id="authBox">
        <h2>Доступ по коду</h2>
        <input id="accessCode" type="text" placeholder="Введите код" autocomplete="off" />
        <button onclick="checkCode()">Войти</button>
        <div id="authError"></div>
    </div>
</div>

<!-- APP -->
<div id="app">
    <h3>Галерея</h3>

    <div id="viewer"><span>Нет фото</span></div>

    <input type="file" id="picker" accept="image/*" multiple hidden />

    <div id="controls">
        <button onclick="pick()">Добавить</button>
        <button onclick="removePhoto()">Удалить</button>
        <button onclick="toggleFull()">На весь экран</button>
    </div>
</div>

<script>
/* =============================
   ONE-TIME ACCESS CODE SYSTEM
==============================*/

const CODE_STORAGE = "validCodesDB";
let validCodes = JSON.parse(localStorage.getItem(CODE_STORAGE)) || [
"AB12CD","Q7X9PL","H2B4KM","W9T3ZA","M8F6CD",
"R4Y7QN","T5L2WP","Z9D8HF","B3N6VE","X7Q1JR",
"K2M9YS","ZX98QW","PL92AB","V7C3KD","JQ55LM",
"TR99WO","NP24QS","HF88ZX","KJ72FE","MD45CL",
"SA71PQ","DL39WE","VM84TZ","CF28RX","YU63NB",
"PO57AJ","GE11KV","TH44MS","WK06YD","RX73PL",
"BN19QF","ZS82GH","KC40VM","LU55RT","AJ90XE",
"QM81DC","PT36BW","FA67HL","ND04JQ","XV29KT",
"HG52PA","LB88CD","MS14QW","DT95ER","FW30UX",
"YP77SK","OV21BZ","CR68TM","JL59HQ","VE03NP"
];

localStorage.setItem(CODE_STORAGE, JSON.stringify(validCodes));
const ACCESS_KEY = "gallery_access_granted";

/* auto-login if device already activated */
if (localStorage.getItem(ACCESS_KEY) === "1") showApp();

function checkCode() {
    const input = accessCode.value.trim().toUpperCase();
    const errorBox = document.getElementById("authError");

    const idx = validCodes.indexOf(input);

    if (idx === -1) {
        errorBox.textContent = "Неверный или использованный код";
        return;
    }

    /* remove code permanently */
    validCodes.splice(idx, 1);
    localStorage.setItem(CODE_STORAGE, JSON.stringify(validCodes));
    localStorage.setItem(ACCESS_KEY, "1");
    showApp();
}

function showApp() {
    document.getElementById("authScreen").style.display = "none";
    document.getElementById("app").style.display = "flex";
}


/* =============================
   GALLERY
==============================*/

let photos = JSON.parse(localStorage.getItem("photos") || "[]");
let index = 0;
let full = false;

function pick(){ picker.click(); }

picker.addEventListener("change", async e => {
    for (const f of e.target.files){
        photos.push(await toB64(f));
    }
    save();
    show();
});

function toB64(file){
    return new Promise(res=>{
        const r = new FileReader();
        r.onload=()=>res(r.result);
        r.readAsDataURL(file);
    });
}

function show(){
    const area = document.getElementById("viewer");

    if(!photos.length){
        area.innerHTML = "<span>Нет фото</span>";
        return;
    }

    area.innerHTML = `<img src="${photos[index]}" id="img">`;
    document.getElementById("img").onclick = next;
}

function next(){
    index = (index + 1) % photos.length;
    show();
}

function removePhoto(){
    if(!photos.length) return;
    photos.splice(index,1);
    if(index > 0) index--;
    save();
    show();
}

function toggleFull(){
    full = !full;
    document.body.classList.toggle("fullscreen", full);
}

function save(){ localStorage.setItem("photos", JSON.stringify(photos)); }

show();
</script>
</body>
</html>
